# OOM基本原理

* OOM（Out Of Memory）是一种系统在严重缺乏内存时采取的应急措施，它会杀死一些进程来释放内存，以保证系统的稳定运行。

* **OOM的触发条件**是当系统没有足够的空闲页（free pages）来满足新的内存请求时，就会启动OOM killer来选择并杀死一些进程。

* OOM的触发条件有以下几种情况：
 - 系统剩余的可用物理内存低于内核预设的阈值，该阈值可以通过```/proc/sys/vm/min_free_kbytes```设置
 - 系统的内存分配请求超过了overcommit机制允许的范围，该机制可以通过```/proc/sys/vm/overcommit_memory```和```/proc/sys/vm/overcommit_ratio```设置
 - 系统的内存碎片过多，导致无法分配一个连续的物理内存块
 - 系统的swap空间不足，导致无法将不常用的内存页换出到磁盘

* 空闲页是指没有被任何进程或者内核使用的物理内存页，它们可以被分配给需要内存的进程或者内核。系统的空闲页数量取决于系统的物理内存大小、交换空间大小、内存使用情况、内存回收机制等因素。

* **OOM killer的选择算法**:  OOM killer会根据每个进程或者线程的OOM分数（oom_score）来选择要杀死的进程或者线程，OOM分数越高，表示该进程或者线程越有可能被杀死。

* **OOM分数**是由多个因素综合计算得到的，主要包括以下几个方面：
  - 进程或者线程占用的内存量，包括物理内存和交换空间。占用的内存量越大，OOM分数越高。
  - 进程或者线程的OOM调整值（oom_adj或者oom_score_adj），这是一个可以由用户或者程序设置的参数，用于影响进程或者线程被杀死的可能性。OOM调整值越大，OOM分数越高。
  - 进程或者线程的CPU使用率和运行时间。CPU使用率和运行时间越高，表示该进程或者线程越活跃，OOM分数越低。
  - 进程或者线程是否是孤儿进程（orphan process），即没有父进程的进程。孤儿进程通常是由于父进程异常退出而遗留下来的，它们往往没有什么用处，OOM分数较高。
  - 进程或者线程是否是特殊进程（special process），即对系统有重要作用的进程，比如init、kswapd、kthreadd等。特殊进程通常不会被OOM killer杀死，除非系统已经无法正常运行了，它们的OOM分数较低。

* **OOM killer的执行过程**: 当OOM killer选择了要杀死的进程或者线程后，它会向该进程或者线程发送SIGKILL（kill -9）信号，强制终止该进程或者线程，并且释放其占用的内存资源。然后，它会检查系统是否还有其他需要内存的请求，如果有，它会继续选择并杀死其他进程或者线程，直到系统有足够的空闲页来满足所有请求为止。

* OOM killer的输出日志：当OOM killer执行时，它会将一些相关信息输出到系统日志中，包括触发OOM的进程或者线程、系统内存和交换空间的使用情况、可能被杀死的候选者列表、最终被杀死的进程或者线程等。这些信息可以帮助我们分析和定位内存问题的原因和影响。























---
